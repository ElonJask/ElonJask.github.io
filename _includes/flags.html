<!-- Smart Language Switch -->
{% if page.collection == 'posts' or page.collection == 'posts_en' %}
{% comment %} We're on a post page {% endcomment %}
{% assign current_filename = page.path | split: '/' | last %}
{% assign target_post = nil %}

{% if page.collection == 'posts' %}
{% comment %} Currently viewing Chinese post, find English version {% endcomment %}
{% if page.translation_key %}
{% assign target_post = site.posts_en | where: "translation_key", page.translation_key | first %}
{% endif %}
{% unless target_post %}
{% assign target_post = site.posts_en | where_exp: "item", "item.path contains current_filename" | first %}
{% endunless %}
{% if target_post %}
{% assign switch_url = target_post.url %}
{% assign en_title = "View English version" %}
{% else %}
{% assign switch_url = '/en/' %}
{% assign en_title = "No translation available, go to English homepage" %}
{% endif %}
<li class="header-item language-item">
  <a href="{{ switch_url }}" class="language-switch" aria-label="Switch to English" title="{{ en_title }}">En</a>
</li>
{% else %}
{% comment %} Currently viewing English post, find Chinese version {% endcomment %}
{% if page.translation_key %}
{% assign target_post = site.posts | where: "translation_key", page.translation_key | first %}
{% endif %}
{% unless target_post %}
{% assign target_post = site.posts | where_exp: "item", "item.path contains current_filename" | first %}
{% endunless %}
{% if target_post %}
{% assign switch_url = target_post.url %}
{% assign zh_title = "查看中文版本" %}
{% else %}
{% assign switch_url = '/' %}
{% assign zh_title = "暂无翻译，跳转到中文首页" %}
{% endif %}
<li class="header-item language-item">
  <a href="{{ switch_url }}" class="language-switch" aria-label="Switch to Chinese" title="{{ zh_title }}">中</a>
</li>
{% endif %}
{% else %}
{% comment %} Non-post pages: keep current path and only switch language prefix {% endcomment %}
{% assign current_url = page.url | default: '/' | replace: '/index.html', '/' %}
{% if current_url == '' %}
{% assign current_url = '/' %}
{% endif %}

{% assign is_en_page = false %}
{% if current_url == '/en' or current_url == '/en/' or current_url contains '/en/' %}
{% assign is_en_page = true %}
{% endif %}

{% if is_en_page %}
{% assign switch_url = current_url | replace_first: '/en', '' %}
{% if switch_url == '' %}
{% assign switch_url = '/' %}
{% endif %}
{% assign fallback_url = '/' %}
{% assign switch_label = '中' %}
{% assign switch_aria = 'Switch to Chinese' %}
{% assign switch_title = '切换到中文页面' %}
{% else %}
{% if current_url == '/' %}
{% assign switch_url = '/en/' %}
{% else %}
{% assign switch_url = '/en' | append: current_url %}
{% endif %}
{% assign fallback_url = '/en/' %}
{% assign switch_label = 'En' %}
{% assign switch_aria = 'Switch to English' %}
{% assign switch_title = 'Switch to English page' %}
{% endif %}

{% assign switch_page = site.pages | where: "url", switch_url | first %}
{% unless switch_page %}
{% assign switch_url = fallback_url %}
{% endunless %}

<li class="header-item language-item">
  <a href="{{ switch_url | relative_url }}" class="language-switch" aria-label="{{ switch_aria }}" title="{{ switch_title }}">{{ switch_label }}</a>
</li>
{% endif %}
