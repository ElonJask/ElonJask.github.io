<head>
  <meta charset="utf-8">
  <title>{% if page.layout == 'home' and page.title %}{{ page.title }}{% elsif page.layout == 'post' or page.hideHomeActive or page.is404 %}{{ page.title }} - {{ site.title }}{% else %}{{ site.title }}{% endif %}</title>
  {% if page.summary %}
  <meta name="description" content="{{ page.summary | strip_html | truncate: 160 }}">
  {% else %}
  <meta name="description" content="{{ site.description }}">
  {% endif %}
  {% if page.tags %}
  <meta name="keywords" content="{{ page.tags | join: ', ' }}">
  {% endif %}
  {% if site.google_site_verification and site.google_site_verification != "" %}
  <meta name="google-site-verification" content="{{ site.google_site_verification }}">
  {% endif %}
  {% assign is_post = false %}
  {% if page.collection == 'posts' or page.collection == 'posts_en' or page.layout == "post" %}
    {% assign is_post = true %}
  {% endif %}
  {% assign is_en_page = false %}
  {% if page.collection == 'posts_en' or page.lang == 'en-US' or page.lang == 'en' or page.url contains '/en/' %}
    {% assign is_en_page = true %}
  {% endif %}
  {% assign use_jinkai = false %}
  {% if is_post and is_en_page == false %}
    {% assign use_jinkai = true %}
  {% endif %}
  {% assign enable_giscus = false %}
  {% if is_post and page.comments != false %}
    {% assign enable_giscus = true %}
  {% endif %}

  <!-- Viewport and Theme Color -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#e8e8e8">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- Open Graph Metadata -->
  {% assign og_title = page.title | default: site.title %}
  {% assign og_description = page.summary | default: site.description %}
  {% assign og_image = page.feature | default:
  "https://gw.alicdn.com/imgextra/i1/O1CN01BjlaXE1auDGoniJGl_!!6000000003389-2-tps-480-444.png" %}

  {% if page.feature %}
  <link rel="preload" as="image" href="{{ page.feature | cdn_image_url }}" fetchpriority="high">
  {% endif %}

  <meta property="og:locale" content="{{ site.lang }}">
  {% if page.layout == "post" %}
  <meta property="og:type" content="article">
  <meta property="article:published_time" content="{{ page.date | date_to_xmlschema }}">
  <meta property="article:author" content="{{ site.author.name | default: site.title }}">
  {% if page.categories %}
  <meta property="article:section" content="{{ page.categories | first }}">
  {% endif %}
  {% else %}
  <meta property="og:type" content="website">
  {% endif %}
  <meta property="og:title" content="{% if page.title %}{{ page.title }} - {{ site.title }}{% else %}{{ site.title }}{% endif %}">
  <meta property="og:description" content="{{ og_description }}">
  <meta property="og:url" content="{{ site.url }}{{ page.url }}">
  <meta property="og:site_name" content="{{ site.title }}">
  <meta property="og:image" content="{{ og_image }}">

  <!-- Twitter Metadata -->
  {% if page.layout == "post" %}
  {% assign twitter_image = page.feature | default:
  "https://gw.alicdn.com/imgextra/i3/O1CN01cSkdn72AKKBDPm829_!!6000000008184-2-tps-2664-2664.png" %}
  <meta name="twitter:card" content="{% if page.feature %}summary_large_image{% else %}summary{% endif %}">
  {% if site.twitter and site.twitter != "" %}
  <meta name="twitter:creator" content="@{{ site.twitter }}">
  <meta name="twitter:site" content="@{{ site.twitter }}">
  {% endif %}
  <meta name="twitter:url" content="{{ site.url }}{{ page.url }}">
  <meta name="twitter:title" content="{{ page.title }} - {{ site.title }}">
  <meta name="twitter:description" content="{{ page.summary }}">
  <meta name="twitter:image" content="{{ twitter_image }}">
  {% endif %}

  <!-- Canonical URL -->
  {% capture canonical %}{{ site.url }}{% if site.permalink contains '.html' %}{{ page.url }}{% else %}{{ page.url |
  remove: 'index.html' | strip_slash }}{% endif %}{% endcapture %}
  <link rel="canonical" href="{{ canonical }}">

  <!-- Hreflang for multilingual content -->
  {% assign zh_url = nil %}
  {% assign en_url = nil %}
  {% if page.collection == 'posts' or page.collection == 'posts_en' %}
    {% assign pair_key = page.translation_key %}
    {% if pair_key %}
      {% assign zh_post = site.posts | where: "translation_key", pair_key | first %}
      {% assign en_post = site.posts_en | where: "translation_key", pair_key | first %}
    {% endif %}
    {% if page.collection == 'posts' %}
      {% assign zh_url = page.url %}
      {% if en_post %}
        {% assign en_url = en_post.url %}
      {% endif %}
    {% else %}
      {% assign en_url = page.url %}
      {% if zh_post %}
        {% assign zh_url = zh_post.url %}
      {% endif %}
    {% endif %}
  {% elsif page.url contains '/en/' %}
    {% assign en_url = page.url %}
    {% assign zh_candidate = page.url | remove_first: '/en' %}
    {% assign zh_page = site.pages | where: "url", zh_candidate | first %}
    {% if zh_page %}
      {% assign zh_url = zh_page.url %}
    {% endif %}
  {% else %}
    {% assign zh_url = page.url %}
    {% assign en_candidate = '/en' | append: page.url %}
    {% assign en_page = site.pages | where: "url", en_candidate | first %}
    {% if en_page %}
      {% assign en_url = en_page.url %}
    {% endif %}
  {% endif %}
  {% if zh_url %}
  <link rel="alternate" hreflang="zh-CN" href="{{ site.url }}{{ zh_url }}" />
  {% endif %}
  {% if en_url %}
  <link rel="alternate" hreflang="en" href="{{ site.url }}{{ en_url }}" />
  {% endif %}
  {% if zh_url %}
  <link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ zh_url }}" />
  {% else %}
  <link rel="alternate" hreflang="x-default" href="{{ site.url }}{{ page.url }}" />
  {% endif %}

  <!-- DNS Prefetch & Preconnect for Performance -->
  <link rel="dns-prefetch" href="https://gw.alicdn.com">
  {% if use_jinkai %}
  <link rel="dns-prefetch" href="https://gw.alipayobjects.com">
  <link rel="preconnect" href="https://gw.alipayobjects.com" crossorigin>
  {% endif %}
  {% if site.google_analytics and site.google_analytics != "" %}
  <link rel="preconnect" href="https://www.googletagmanager.com">
  {% endif %}
  {% if enable_giscus %}
  <link rel="preconnect" href="https://giscus.app">
  <link rel="dns-prefetch" href="https://giscus.app">
  {% endif %}

  <!-- Styles and Scripts -->
  <link rel="stylesheet" href="{{ site.baseurl }}/css/index.css">
  {% if use_jinkai %}
  <link rel="stylesheet" href="{{ site.baseurl }}/css/jinkai.css" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="{{ site.baseurl }}/css/jinkai.css"></noscript>
  {% endif %}

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="{{ site.baseurl }}/images/favicon.png">
  <link rel="shortcut icon" type="image/png" href="{{ site.baseurl }}/images/favicon.png">

  <!-- Additional Meta Tags -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta http-equiv="cleartype" content="on">
  <meta name="format-detection" content="telephone=no">
  <meta name="author" content="{{ site.author.name | default: site.title }}">
  {% if page.noindex or page.is404 %}
  <meta name="robots" content="noindex, follow">
  {% else %}
  <meta name="robots" content="index, follow">
  {% endif %}

  <!-- Feed -->
  <link href="{{ site.baseurl }}/feed.xml" type="application/atom+xml" rel="alternate" title="{{ site.title }} Feed">

  <!-- Structured Data for SEO and AI Crawlers -->
  {% if page.layout == "post" %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "{{ page.title }}",
    "datePublished": "{{ page.date | date_to_xmlschema }}",
    "dateModified": "{{ page.date | date_to_xmlschema }}",
    "author": {
      "@type": "Person",
      "name": "{{ site.author.name | default: site.title }}",
      "url": "{{ site.author.url | default: site.url }}",
      "sameAs": [
        "https://github.com/{{ site.author.github }}"{% if site.author.twitter and site.author.twitter != "" %},
        "https://twitter.com/{{ site.author.twitter }}"{% endif %}
      ]
    },
    "publisher": {
      "@type": "Organization",
      "name": "{{ site.title }}",
      "logo": {
        "@type": "ImageObject",
        "url": "{{ site.url }}/images/favicon.png"
      }
    },
    "description": "{{ page.summary | default: page.excerpt | strip_html | truncate: 160 | default: site.description }}",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "{{ site.url }}{{ page.url }}"
    },
    "url": "{{ site.url }}{{ page.url }}",
    "inLanguage": "{{ page.lang | default: site.lang }}",
    "keywords": "{{ page.categories | join: ', ' }}{% if page.tags %}, {{ page.tags | join: ', ' }}{% endif %}"{% if page.feature %},
    "image": {
      "@type": "ImageObject",
      "url": "{{ page.feature }}"
    }{% endif %}
  }
  </script>
  {% else %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "{{ site.title }}",
    "url": "{{ site.url }}",
    "description": "{{ site.description }}",
    "author": {
      "@type": "Person",
      "name": "{{ site.author.name | default: site.title }}",
      "url": "{{ site.author.url | default: site.url }}"
    },
    "inLanguage": "{{ site.lang }}",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "{{ site.url }}/search.json?q={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>
  {% endif %}
</head>
