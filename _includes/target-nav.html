{% assign is_en_nav = false %}
{% if page.collection == 'posts_en' or page.lang == 'en-US' or page.lang == 'en' or page.url contains '/en/' %}
  {% assign is_en_nav = true %}
{% endif %}
{% assign nav_menu = site.menu_zh %}
{% if is_en_nav %}
  {% assign nav_menu = site.menu_en %}
{% endif %}
{% assign current_url = page.url | default: '/' | replace: '/index.html', '/' %}
{% if current_url == '' %}{% assign current_url = '/' %}{% endif %}

{% assign switch_url = '/' %}
{% if page.collection == 'posts' or page.collection == 'posts_en' %}
  {% assign current_filename = page.path | split: '/' | last %}
  {% assign target_post = nil %}
  {% if page.collection == 'posts' %}
    {% if page.translation_key %}
      {% assign target_post = site.posts_en | where: 'translation_key', page.translation_key | first %}
    {% endif %}
    {% unless target_post %}
      {% assign target_post = site.posts_en | where_exp: 'item', 'item.path contains current_filename' | first %}
    {% endunless %}
    {% if target_post %}
      {% assign switch_url = target_post.url %}
    {% else %}
      {% assign switch_url = '/en/' %}
    {% endif %}
  {% else %}
    {% if page.translation_key %}
      {% assign target_post = site.posts | where: 'translation_key', page.translation_key | first %}
    {% endif %}
    {% unless target_post %}
      {% assign target_post = site.posts | where_exp: 'item', 'item.path contains current_filename' | first %}
    {% endunless %}
    {% if target_post %}
      {% assign switch_url = target_post.url %}
    {% else %}
      {% assign switch_url = '/' %}
    {% endif %}
  {% endif %}
{% else %}
  {% if is_en_nav %}
    {% assign switch_url = current_url | replace_first: '/en', '' %}
    {% if switch_url == '' %}{% assign switch_url = '/' %}{% endif %}
  {% else %}
    {% if current_url == '/' %}
      {% assign switch_url = '/en/' %}
    {% else %}
      {% assign switch_url = '/en' | append: current_url %}
    {% endif %}
  {% endif %}
{% endif %}

{% assign lang_title = 'Switch Language' %}
{% assign lang_aria = 'Switch language' %}
{% assign mobile_switch_text = 'EN' %}
{% if is_en_nav %}
  {% assign lang_title = '切换到中文' %}
  {% assign lang_aria = '切换到中文' %}
  {% assign mobile_switch_text = '中' %}
{% else %}
  {% assign lang_title = 'Switch to English' %}
  {% assign lang_aria = 'Switch to English' %}
  {% assign mobile_switch_text = 'EN' %}
{% endif %}

<div class="navigatebar{% unless is_en_nav %} is-zh{% endunless %}">
  <div class="navigatebar-left">
    <div class="navigatebar-button navigatebar-mine">
      <a href="{% if is_en_nav %}{{ '/en/' | relative_url }}{% else %}{{ '/' | relative_url }}{% endif %}">{{ site.title }}</a>
    </div>
  </div>

  <div class="navigatebar-center">
    {% for menu in nav_menu %}
      {% assign href = menu.url %}
      {% if href contains 'http://' or href contains 'https://' %}
        <div class="navigatebar-button navigatebar-menu-item"><a href="{{ href }}" target="_blank" rel="noopener noreferrer">{{ menu.title }}</a></div>
      {% else %}
        {% if is_en_nav %}
          {% unless href contains '/en/' %}
            {% assign href = '/en' | append: href %}
          {% endunless %}
        {% endif %}
        {% assign nav_item_url = href | replace: '/index.html', '/' %}
        {% assign current_base = current_url | replace: '.html', '' %}
        {% assign nav_base = nav_item_url | replace: '.html', '' %}
        {% assign is_active_menu = false %}
        {% if current_base == nav_base or current_base == nav_base | append: '/' or nav_base == current_base | append: '/' %}
          {% assign is_active_menu = true %}
        {% endif %}
        <div class="navigatebar-button navigatebar-menu-item"><a href="{{ href | relative_url }}"{% if is_active_menu %} class="is-active"{% endif %}>{{ menu.title }}</a></div>
      {% endif %}
    {% endfor %}
  </div>

  <div class="navigatebar-right">
    <div class="navigatebar-button navigatebar-about">
      <a href="{{ switch_url | relative_url }}" class="lang-switch-icon" aria-label="{{ lang_aria }}" title="{{ lang_title }}">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="12" r="8.5" stroke="currentColor" stroke-width="1.8"/>
          <path d="M3.8 12h16.4M12 3.8c2.9 2.4 4.4 5.1 4.4 8.2s-1.5 5.8-4.4 8.2m0-16.4c-2.9 2.4-4.4 5.1-4.4 8.2s1.5 5.8 4.4 8.2" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
        </svg>
      </a>
      <a href="{{ switch_url | relative_url }}" class="lang-switch-text" aria-label="{{ lang_aria }}" title="{{ lang_title }}">{{ mobile_switch_text }}</a>
    </div>
  </div>
</div>
